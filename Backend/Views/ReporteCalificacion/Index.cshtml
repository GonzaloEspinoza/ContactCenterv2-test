@using Logica;
@using Entidad;
@using Entidad.Enums;
@using DataP;
@using Backend.Models;

@{
    ViewBag.Title = ViewBag.Titulo;
    Layout = "~/Views/Shared/_Layout.cshtml";
    DataP.Usuario oUsuario = Util.SessionToUsuario<DataP.Usuario>(Session["Usuario"]);
    List<EFuncionario> Colaborares = (List<EFuncionario>)ViewBag.Colaborares;

}
@section EtiquetaHead
{
<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/morris/morris.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css")" rel="stylesheet" />

<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-select/css/bootstrap-select.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/map-google.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-colorpicker/css/colorpicker.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/jquery-minicolors/jquery.minicolors.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-modal/css/bootstrap-modal.css")" rel="stylesheet" />
<script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-select/js/bootstrap-select.js")"></script>
<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-select/css/bootstrap-select.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css")" rel="stylesheet" />
<script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js")" type="text/javascript"></script>
<link href="@Url.Content("~/Content/metronic/global/plugins/jquery-multi-select/css/multi-select.css")" rel="stylesheet" />
<script src="@Url.Content("~/Content/metronic/global/plugins/jquery-multi-select/js/jquery.multi-select.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/jquery-multi-select/js/jquery.quicksearch.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/ckeditor/ckeditor.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-modal/js/bootstrap-modal.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/jquery-minicolors/jquery.minicolors.min.js")"></script>
<script src="@Url.Content("~/Content/metronic/pages/scripts/components-color-pickers.min.js")"></script>
}


   

            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-4">
                        <div class="form-group">
                            <select class="bs-select form-control" id="funcionarioId" data-live-search="true">
                                @if (Colaborares.Count > 1)
                                {
                                    <option value="-1">Todos</option>
                                }
                                @foreach (var item in Colaborares)
                                {
                                    <option value="@item.nFuncionarioId">@item.sNombre @item.sApellido</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div id="fecha" class="col-md-4" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; ">
                        <i class="fa fa-calendar"></i>&nbsp;
                        <span></span> <i class="fa fa-caret-down"></i>
                    </div>
                </div>
            </div>



            <!-- END PAGE HEAD-->
            <!-- BEGIN PAGE BASE CONTENT -->
            <div class="row widget-row">

                <div class="col-md-4">
                    <!-- BEGIN WIDGET THUMB -->
                    <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered">
                        <h4 class="widget-thumb-heading">Clientes atendidos</h4>
                        <div class="widget-thumb-wrap">
                            <i class="widget-thumb-icon bg-green icon-bulb"></i>
                            <div class="widget-thumb-body">
                                <span class="widget-thumb-subtitle">Clientes</span>
                                <span class="widget-thumb-body-stat" id="numeroClientesAtendidos">0</span>
                            </div>
                        </div>
                    </div>
                    <!-- END WIDGET THUMB -->
                </div>
                <div class="col-md-4">
                    <!-- BEGIN WIDGET THUMB -->
                    <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered">
                        <h4 class="widget-thumb-heading">Calificaciones enviadas</h4>
                        <div class="widget-thumb-wrap">
                            <i class="widget-thumb-icon bg-red icon-layers"></i>
                            <div class="widget-thumb-body">
                                <span class="widget-thumb-subtitle">Enviadas</span>
                                <span class="widget-thumb-body-stat" id="numeroCalificacionesEnviadas">0</span>
                            </div>
                        </div>
                    </div>
                    <!-- END WIDGET THUMB -->
                </div>
                <div class="col-md-4">
                    <!-- BEGIN WIDGET THUMB -->
                    <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered">
                        <h4 class="widget-thumb-heading">Promedio calificaciones</h4>
                        <div class="widget-thumb-wrap">
                            <i class="widget-thumb-icon bg-purple icon-screen-desktop"></i>
                            <div class="widget-thumb-body">
                                <span class="widget-thumb-subtitle">Puntos</span>
                                <span class="widget-thumb-body-stat" id="promedioCalificaciones">0</span>
                            </div>
                        </div>
                    </div>
                    <!-- END WIDGET THUMB -->
                </div>
               
            </div>
            <div class="row">
                <div class="col-md-12 col-sm-12">
                    <div class="portlet light bordered">
                        <div class="portlet-title">
                            <div class="caption font-green">
                                <span class="caption-subject bold uppercase">Califiaciones y comentarios</span>
                            </div>
                        </div>
                        <div id="ContenedorLista" class="portlet-body">
                            <table class="table table-striped table-bordered table-hover" id="sample_2">
                                <thead>
                                    <tr>
                                        <th>EVENTO ID</th>
                                        <th>CALIFICACION</th>
                                        <th>COMENTARIO</th>
                                        <th>COLABORADOR</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- END PAGE BASE CONTENT -->

@section Scripts
{

<script src="@Url.Content("~/Scripts/metronic/global/plugins/moment.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/morris/morris.min.js")"></script>

<script src="@Url.Content("~/Scripts/metronic/global/plugins/morris/raphael-min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/counterup/jquery.waypoints.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/counterup/jquery.counterup.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amcharts/amcharts.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amcharts/serial.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amcharts/pie.js")"></script>


<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amcharts/radar.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amcharts/themes/light.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amcharts/themes/patterns.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/ammap/ammap.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/ammap/maps/js/worldLow.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/amcharts/amstockcharts/amstock.js")"></script>


<script src="@Url.Content("~/Scripts/metronic/global/plugins/flot/jquery.flot.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/flot/jquery.flot.resize.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/flot/jquery.flot.categories.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/jquery-easypiechart/jquery.easypiechart.min.js")"></script>
<script src="@Url.Content("~/Scripts/metronic/global/plugins/jquery.sparkline.min.js")"></script>

<link href="@Url.Content("~/Content/metronic/global/plugins/datatables/datatables.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/metronic/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css")" rel="stylesheet" />
<script src="@Url.Content("~/Scripts/metronic/global/scripts/datatable.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/datatables/datatables.min.js")"></script>
<script src="@Url.Content("~/Content/metronic/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js")"></script>
<script type="text/javascript">

    jQuery(document).ready(function () {

        $('.bs-select').selectpicker({
            iconBase: 'fa',
            tickIcon: 'fa-check'
        });
        var start = moment().startOf('month');
        var end = moment().endOf('month');
        $('#fecha').daterangepicker({
            startDate: start,
            endDate: end,
            locale: {
                "customRangeLabel": "Personalizado",
            },
            ranges: {
                'Hoy': [moment(), moment()],
                'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Los últimos 7 días': [moment().subtract(6, 'days'), moment()],
                'Los últimos 30 días': [moment().subtract(29, 'days'), moment()],
                'Este mes': [moment().startOf('month'), moment().endOf('month')],
                'Anterior mes': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        }, FormatearFecha);

        FormatearFecha(start, end);

        function FormatearFecha(start, end) {
            $('#fecha span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        };

        $('#fecha').on('apply.daterangepicker', function (ev, picker) {
            //console.log(picker.startDate.format('DD/MM/YYYY'));
            //console.log(picker.endDate.format('DD/MM/YYYY'));
            cargarDatos(picker.startDate.format('DD/MM/YYYY'),
                picker.endDate.format('DD/MM/YYYY'),
                $('#funcionarioId').val());
            Listar();

        });



        $('#funcionarioId').on('change', function () {
            cargarDatos($('#fecha').data('daterangepicker').startDate.format('DD/MM/YYYY'),
            $('#fecha').data('daterangepicker').endDate.format('DD/MM/YYYY'),
                $('#funcionarioId').val());
            Listar();

        });


        cargarDatos($('#fecha').data('daterangepicker').startDate.format('DD/MM/YYYY'),
            $('#fecha').data('daterangepicker').endDate.format('DD/MM/YYYY'),
                $('#funcionarioId').val());


        function cargarDatos(fechaInicio, fechaFin, funcionarioId) {
            console.log(fechaInicio);
            console.log(fechaFin);
            console.log(funcionarioId);

            LimpiarMensaje();
            BloquearPantalla();
            $.ajax({
                url: "@Url.Action("Estadistica", "ReporteCalificacion")",
                cache: false,
                data: {
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    funcionarioId: funcionarioId
                },
                type: "POST",
                dataType: "script"
            }).complete(function (response) {
                var data = JSON.parse(response.responseText);
                $('#numeroClientesAtendidos').html(`<strong>` + data.numeroClientesAtendidos.toString() + `</strong>`);
                $('#numeroCalificacionesEnviadas').html(`<strong>` + data.numeroCalificacionesEnviadas.toString() + `</strong>`);
                $('#promedioCalificaciones').html(`<strong>` + data.promedioCalificaciones.toString() + `</strong>`);


                DesbloquearPantalla();
            }).done(function (response) {
                DesbloquearPantalla();
                console.log(response);
            }).error(function () {
                DesbloquearPantalla();
            });
        };
        Listar();

    });



    function Listar() {
        LimpiarMensaje();
        BloquearPantalla();
        $('#sample_2').DataTable().destroy();
        $("#sample_2").DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "@Url.Action("ListarCalifiacionesDatatable", "ReporteCalificacion")",
                "data": {
                    'fechaInicio': $('#fecha').data('daterangepicker').startDate.format('DD/MM/YYYY'),
                    'fechaFin': $('#fecha').data('daterangepicker').endDate.format('DD/MM/YYYY'),
                    'funcionarioId': $('#funcionarioId').val()
                },
                "type": "POST",
                "datatype": "json"
            },
            dom: 'Bfrtip',
        lengthMenu: [
            [10, 25, 50, 100],
            ['10 rows', '25 rows', '50 rows', '100 rows']
        ],
        buttons: [
            'pageLength'
        ],
        "filter": true,
        "responsivePriority": 1,
        "data": null,
        "columns": [
            { "data": "EventoId", "autoWidth": true },
            { "data": "Calificacion", "autoWidth": true },
            { "data": "Comentario", "autoWidth": true },
            { "data": "Funcionario", "autoWidth": true }
        ],
        buttons: [
            //{ extend: 'print', className: 'btn dark btn-outline', exportOptions: { columns: [0, 1, 2, 3] } },
            {
                extend: 'copy', className: 'btn purple btn-outline ', orientation: 'landscape',
                pageSize: 'LEGAL', exportOptions: { columns: [0, 1, 2, 3, 4] }
            },
            { extend: 'pdf', className: 'btn green btn-outline', exportOptions: { columns: [0, 1, 2, 3, 4 ] } },
            { extend: 'csv', className: 'btn purple btn-outline ', exportOptions: { columns: [0, 1, 2, 3, 4] } },
            { extend: 'excel', className: 'btn purple btn-outline ', exportOptions: { columns: [0, 1, 2, 3, 4] } }
        ],
        "dom": "<'row' <'col-md-12'B>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r><'table-scrollable't><'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>",

        });
    DesbloquearPantalla();
    }
</script>
}

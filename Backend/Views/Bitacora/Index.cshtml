@using DataP;
@model List<Bitacora>
@{
    ViewBag.Title = "Log de Transacciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
    List<Usuario> usuarios = ViewBag.Usuarios;
}

@section EtiquetaHead
{
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-select/css/bootstrap-select.min.css")" rel="stylesheet" />
    <script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-select/js/bootstrap-select.js")"></script>

    <link href="@Url.Content("~/Content/metronic/global/plugins/datatables/datatables.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css")" rel="stylesheet" />

    <script src="@Url.Content("~/Scripts/metronic/global/scripts/datatable.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/datatables/datatables.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js")"></script>
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/clockface/css/clockface.css")" rel="stylesheet" />

    <script src="@Url.Content("~/Scripts/metronic/global/plugins/moment.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/clockface/js/clockface.js")"></script>


    <script type="text/javascript">

        var TableDatatablesRowreorder = function () {
            var initTable1 = function () {
                var table = $('#sample_1');
                var oTable = table.dataTable({
                    // Internationalisation. For more info refer to http://datatables.net/manual/i18n
                    "language": {
                        "aria": {
                            "sortAscending": ": activate to sort column ascending",
                            "sortDescending": ": activate to sort column descending"
                        },
                        "emptyTable": "No hay datos para mostrar",
                        "info": "Mostrando _START_ a _END_ de _TOTAL_ Transacción",
                        "infoEmpty": "No hay datos para mostrar",
                        "infoFiltered": "(filtered1 from _MAX_ total Transacción)",
                        "lengthMenu": "_MENU_ Transacción",
                        "search": "Buscar:",
                        "zeroRecords": "No se encontraron coincidencias"
                    },

                    // Or you can use remote translation file
                    //"language": {
                    //   url: '//cdn.datatables.net/plug-ins/3cfcc339e89/i18n/Portuguese.json'
                    //},

                    // setup buttons extentension: http://datatables.net/extensions/buttons/
                    buttons: [
                        //{ extend: 'print', className: 'btn dark btn-outline' },
                        { extend: 'copy', className: 'btn purple btn-outline ' },
                        { extend: 'pdf', className: 'btn green btn-outline' },
                        { extend: 'csv', className: 'btn purple btn-outline ' },
                        { extend: 'excel', className: 'btn purple btn-outline ' }
                    ],
                    columnDefs: [

                    ],

                    "order": [
                        [0, 'asc']
                    ],

                    "lengthMenu": [
                        [5, 10, 15, 20, -1],
                        [5, 10, 15, 20, "Todos"] // change per page values here
                    ],
                    // set the initial value
                    "pageLength": 10,

                    "dom": "<'row' <'col-md-12'B>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r><'table-scrollable't><'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>", // horizobtal scrollable datatable

                    // Uncomment below line("dom" parameter) to fix the dropdown overflow issue in the datatable cells. The default datatable layout
                    // setup uses scrollable div(table-scrollable) with overflow:auto to enable vertical scroll(see: assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.js).
                    // So when dropdowns used the scrollable div should be removed.
                    //"dom": "<'row' <'col-md-12'T>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r>t<'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>",
                });
            }

            return {
                //main function to initiate the module
                init: function () {

                    if (!$().dataTable) {
                        return;
                    }
                    initTable1();
                }
            };
        }();

        var Inicio;
        var Fin;

        var handleDateRangePickers = function () {
            if (!jQuery().daterangepicker) {
                return;
            }
            $('.bs-select').selectpicker({
                iconBase: 'fa',
                tickIcon: 'fa-check'
            });
            $('#defaultrange').daterangepicker({
                opens: (App.isRTL() ? 'left' : 'right'),
                format: 'MM/DD/YYYY',
                separator: ' Hasta ',
                startDate: moment(),
                endDate: moment(),
                ranges: {
                    'Hoy': [moment(), moment()],
                    'Ayer': [moment().subtract('days', 1), moment().subtract('days', 1)],
                    'Últimos 7 Días': [moment().subtract('days', 6), moment()],
                    'Últimos 30 Días': [moment().subtract('days', 29), moment()],
                    'Este Mes': [moment().startOf('month'), moment().endOf('month')],
                    'Últimos Mes': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                }
            },
                function (start, end) {
                    Inicio = start.format('YYYY-MM-DDTHH:mm:ss');
                    Fin = end.format('YYYY-MM-DDTHH:mm:ss');
                    $("#FechaInicio").val(Inicio);
                    $("#FechaFin").val(Fin);
                    $('#defaultrange input').val(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                }
            );
        }

        $(document).ready(function () {
            if (jQuery().datepicker) {
                $('.date-picker').datepicker({
                    rtl: App.isRTL(),
                    orientation: "left",
                    autoclose: true
                });
                //$('body').removeClass("modal-open"); // fix bug when inline picker is used in modal
            }
            handleDateRangePickers();
            Inicio = moment().format('YYYY-MM-DDT00:00:00');
            Fin = moment().format('YYYY-MM-DDT00:00:00');
            $("#FechaInicio").val(Inicio);
            $("#FechaFin").val(Fin);
            $('#defaultrange input').val(moment().format('MMMM D, YYYY') + ' - ' + moment().format('MMMM D, YYYY'));
            TableDatatablesRowreorder.init();
        });




        function MostrarMensaje(msj) {
            $("#mensajeError").show();
            $("#mensajeError").html(msj);
        }

        function LimpiarMensajeError() {
            $("#mensajeError").hide();
            $("#mensajeError").html('');
        }

        function RecargarListar() {
            LimpiarMensajeError();

            if (Inicio == '' || Inicio == undefined) {
                MostrarMensaje('Seleccione un rango de fechas.');
                return;
            }
            var UsuarioId = $("#usuario_selector").val();

            BloquearPantalla();
            $.ajax({
                url: "@Url.Action("RecargarListar", "Bitacora")",
                cache: false,
                data: {
                    UsuarioId: UsuarioId,
                    Accion: $("#accion_selector").val(),
                    Tipo: $("#tipo_selector").val(),
                    Inicio: Inicio,
                    Fin: Fin
                },
                type: "POST"
            }).done(function (html) {
                $("#ListaContainer").html(html);
                DesbloquearPantalla();
                TableDatatablesRowreorder.init();
            });
        }


    </script>
}

<div class="page-head">
    <div class="page-title">
        <h1>
            Seguridad
            <small>Log de Transacciones</small>
        </h1>
    </div>
</div>
<ul class="page-breadcrumb breadcrumb">
    <li>
        <a href="@Url.Action("Index","Inicio")">Principal</a>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <span class="active">Log de Transacciones</span>
    </li>
</ul>
<!-- END PAGE HEADER-->
<div class="row">
    <div class="col-md-12">
        <div class="panel">
            <div class="panel-body">
                <span class="labelsAzul">Tipo</span>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <select id="tipo_selector" class="bs-select form-control">
                                <option value="-1" selected>Todos</option>
                                <option value="0">Éxito</option>
                                <option value="1">Error</option>
                            </select>
                        </div>
                    </div>
                </div>
                <span class="labelsAzul">Acción</span>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <select id="accion_selector" class="bs-select form-control">
                                <option value="-1" selected>Todos</option>
                                <option value="0">Creacion</option>
                                <option value="1">Modificación</option>
                                <option value="2">Eliminación</option>
                                <option value="3">Anulación</option>
                                <option value="4">Inicio Sesión</option>
                                <option value="5">Cambio Contraseña</option>
                            </select>
                        </div>
                    </div>
                </div>
                <span class="labelsAzul">Usuario</span>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            @Html.Partial("_ListadoUsuario", usuarios)
                        </div>
                    </div>
                </div>
                <span class="labelsAzul">Fecha</span>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            @Html.Hidden("#FechaInicio")
                            @Html.Hidden("#FechaFin")
                            <div class="input-group" id="defaultrange">
                                <input type="text" class="form-control">
                                <span class="input-group-btn">
                                    <button class="btn default date-range-toggle" type="button">
                                        <i class="fa fa-calendar"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <input class="btn blue uppercase bold" type="button" onclick="RecargarListar()" value="Consultar" />
                </div>
                <div class="alert alert-danger" style="display:none" role="alert" id="mensajeError"></div>
                <br />
                <br />
                <br />
                <!-- BEGIN EXAMPLE TABLE PORTLET-->
                <div class="portlet light ">
                    <div id="ListaContainer" class="portlet-body">
                        @Html.Partial("_ListadoLog", Model)
                    </div>
                </div>
                <!-- END EXAMPLE TABLE PORTLET-->
            </div>
        </div><!--.panel-->
    </div><!--.col-md-12-->
</div><!--.row-->

<div class="modal scale fade" id="dialogoHabilitar" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Diálogo de confirmación</h4>
            </div>
            <div class="modal-body">
                <span id="dialogoHabilitarMensaje"></span>
            </div>
            <div class="modal-footer">
                <button id="btn_cancelar" type="button" class="btn btn-flat btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-flat btn-primary" onclick="HabilitaroDeshabilitar()">Aceptar</button>
            </div>
        </div><!--.modal-content-->
    </div><!--.modal-dialog-->
</div><!--.modal-->

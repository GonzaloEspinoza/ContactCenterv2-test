@using Logica;
@using Entidad;
@using Entidad.Enums;
@using DataP;
@using Backend.Models;
@{
    DataP.Usuario oUsuario = Util.SessionToUsuario<DataP.Usuario>(Session["Usuario"]);
    bool menuAbierto = (bool)Session["menuAbierto"];
    string claseMenu = menuAbierto==true?
        "page-header-fixed page-sidebar-closed-hide-logo page-container-bg-solid page-md page-content-white page-sidebar-fixed":
        "page-header-fixed page-sidebar-closed-hide-logo page-container-bg-solid page-md page-content-white page-sidebar-fixed page-sidebar-closed";
    string imageUsuario = (string)Session["ImagenU"];
    Logica.LUsuarioBackEnd NUsuarioAdministrativo = Logica.LBaseCC<DataP.Usuario>.Instancia.LUsuarioBackEnd;
    List<string> toasts = ViewBag.Toasts == null ? new List<string>() : ViewBag.Toasts;

    long sesionTimeOut = (long)Session["timeOut"] * 1000 * 60;
    long toastTimeOut = (long)Session["timeToast"] * 1000;
}
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="" name="description" />
    <meta content="" name="author" />
    <title>@ViewBag.Title</title>
    <link rel="shortcut icon" type="image/x-icon" href="~/Content/img/logo.png " />
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/font-awesome/css/font-awesome.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/simple-line-icons/simple-line-icons.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap/css/bootstrap.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/uniform/css/uniform.default.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css")" rel="stylesheet" />
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN THEME GLOBAL STYLES -->
    <link href="@Url.Content("~/Content/metronic/global/css/components-md.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/global/css/plugins-md.min.css")" rel="stylesheet" />
    <!-- END THEME GLOBAL STYLES -->
    <!-- BEGIN THEME LAYOUT STYLES -->
    <link href="@Url.Content("~/Content/metronic/layouts/layout4/css/layout.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/metronic/layouts/layout4/css/themes/light.min.css")" rel="stylesheet" id="style_color" />
    <link href="@Url.Content("~/Content/metronic/layouts/layout4/css/custom.min.css")" rel="stylesheet" />
    <!-- END THEME LAYOUT STYLES -->
    <!-- BEGIN CORE PLUGINS -->
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/jquery.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/bootstrap/js/bootstrap.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/js.cookie.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/jquery.blockui.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/uniform/jquery.uniform.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js")"></script>
    <!-- END CORE PLUGINS -->
    <!-- BEGIN THEME GLOBAL SCRIPTS -->
    <script src="@Url.Content("~/Scripts/metronic/global/scripts/app.min.js")"></script>
    <!-- END THEME GLOBAL SCRIPTS -->
    <!-- BEGIN THEME LAYOUT SCRIPTS -->
    <script src="@Url.Content("~/Scripts/metronic/layouts/layout4/scripts/layout.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/layouts/layout4/scripts/demo.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/layouts/global/scripts/quick-sidebar.min.js")"></script>
    <!-- END THEME LAYOUT SCRIPTS -->
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/bootstrap-sessiontimeout/bootstrap-session-timeout.min.js")"></script>
    <script src="@Url.Content("~/Content/metronic/global/plugins/bootstrap-toastr/toastr.min.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/jquery.sparkline.min.js")"></script>

    <script src="@Url.Content("~/Scripts/metronic/global/plugins/codemirror/lib/codemirror.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/codemirror/mode/javascript/javascript.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/codemirror/mode/htmlmixed/htmlmixed.js")"></script>
    <script src="@Url.Content("~/Scripts/metronic/global/plugins/codemirror/mode/css/css.js")"></script>
    <link href="@Url.Content("~/Content/metronic/global/plugins/bootstrap-toastr/toastr.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/jquery-ui.css")" rel="stylesheet" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
   
    @RenderSection("head", required: false)
    <script>

        function MostrarMensaje(msj) {
            $("#mensajeError").show();
            $("#mensajeError").attr('class', 'alert alert-danger');
            $("#mensajeError").html(msj);
        }

        function LimpiarMensaje() {
            $("#mensajeError").hide();
            $("#mensajeError").html('');
        }

        var toasts = [];

        function showAlertError(message) {
            showAlertErrorContenedor('', message);
        }

        function showAlertErrorContenedor(container, message) {
            App.alert({
                container: container,
                place: 'append',
                type: 'danger',
                message: message,
                close: true,
                reset: false,
                focus: true,
            });
        }

        function limpiarAlerta() {
            $('.custom-alerts').remove();
        }

        function showToastError(titulo, mensaje) {
            toastr.options = {
                "closeButton": true,
                "debug": true,
                "positionClass": "toast-top-right",
                "showDuration": "1000",
                "hideDuration": "1000",
                "timeOut": "@sesionTimeOut",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "slideDown",
                "hideMethod": "slideUp"
            }
            toastr["error"](mensaje, titulo);
        }

        function showToast(titulo, mensaje) {
            toastr.options = {
                "closeButton": true,
                "debug": true,
                "positionClass": "toast-top-right",
                "showDuration": "1000",
                "hideDuration": "1000",
                "timeOut": "@toastTimeOut",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "slideDown",
                "hideMethod": "slideUp"
            }
            toastr["success"](mensaje, titulo);
        }

        var SessionTimeout = function () {
            var handlesessionTimeout = function () {
                $.sessionTimeout({
                    title: 'Tiempo límite de sesión',
                    message: 'Su sesión está a punto de caducar.',
                    keepAliveUrl: '@Url.Action("MantenerEnSesion", "Login", new { param1 = oUsuario.UsuarioId })',
                    redirUrl: '@Url.Action("Bloquear", "Login")',
                    logoutUrl: '@Url.Action("CerrarSesion", "Login")',
                    warnAfter: 600000,
                    redirAfter: 1200000,
                    countdownMessage: 'Redireccionando en {timer} segundos.',
                    countdownBar: true
                });
            }
            return {
                init: function () {
                    handlesessionTimeout();
                }
            };
        }();

        function procesarErrorGenerico(er) {
            if (er.status == 403) {
                var responseTextJson = JSON.parse(er.responseText);
                redireccionar(responseTextJson.LogOnUrl);
                return 'Su sesión ah expirado.';
            } else if (er.status == 200) {
                return 'Error desconocido, contacte al administrador.';
            }
            return er.statusText;
        }

        function resizedataURL(datas, wantedWidth, wantedHeight, callback) {
            var img = document.createElement('img');
            img.onload = function () {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var nw = wantedWidth;
                var nh = wantedHeight;
                if ((this.width < this.height)) {
                    nw = this.width * nh / this.height;
                } else if (this.width > this.height) {
                    nh = this.height * nw / this.width;
                }
                canvas.width = nw;
                canvas.height = nh;
                ctx.drawImage(this, 0, 0, nw, nh);
                imageBase64 = canvas.toDataURL();
                if (callback != undefined) {
                    callback();
                }
            };
            img.src = datas;
        }

        $(document).ready(function () {
            for (i = 0; i < toasts.length; i++) {
                showToast(toasts[i].titulo, toasts[i].mensaje);
            }
            $('#botonToggler').click(function () {
                //console.log('@menuAbierto');
                $.ajax({
                    url: "@Url.Action("ActualizarEstadoMenu", "Inicio")",
                    cache: false,
                    data: {
                        estado: '@menuAbierto'
                    },
                    type: "POST"
                }).complete(function (response) {
                }).done(function () {
                }).error(function () {
                });

            });
        });

        function redireccionar(url) {
            window.location = url;
        }


        function open(url) {
            redireccionar(url);
        }

        function BloquearDiv(div) {
            $.blockUI({
                //target: div,
                overlayCSS: { backgroundColor: '#fff' },
                animate: true,
                baseZ: 10100,
                css: { backgroundColor: 'transparent', color: '#fff', border: 'none', },
                message: '<h1><img src="@Url.Content("~/Images/32x32.gif")"/></h1>'
            });
        }

        function BloquearPantalla() {
            BloquearDiv('#blockui_sample_3_2_element');
        }

        function DesbloquearDiv(div) {
            $.unblockUI();
        }
        function DesbloquearPantalla() {
            DesbloquearDiv('#blockui_sample_3_2_element');
        }

        function ValidarCaracteresEspeciales(campo) {
            var letras = /^\s*[a-zA-Z0-9,\s,ñ,á,é,í,ó,ú]+\s*$/;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(letras)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }
        function ValidarCaracteresEspecialesSinEspacios(campo) {
            var letras = /^\s*[a-zA-Z0-9,ñ,á,é,í,ó,ú]+\s*$/;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(letras)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }

        function ValidarCaracteresEspecialesSuc(campo) {
            var letras = /^\s*[a-zA-Z0-9,\s,ñ,á,é,í,ó,ú,.]+\s*$/;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(letras)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }

        function ValidarSoloNumeros(campo) {
            var numeros = /^[0-9]+$/;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(numeros)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }

        function ValidarDecimales(campo) {
            var numeros = /^[0-9]{1,20}(\,[0-9]{0,2})?$/;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(numeros)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }

        function ValidarCorreoElectronico(campo) {
            var correo = /[A-Z0-9._%+-]+@@[A-Z0-9.-]+.[A-Z]{2,4}/igm;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(correo)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }

        function ValidarSoloLetras(campo) {
            var letras = /^\s*[a-zA-Z,\s,ñ,á,é,í,ó,ú]+\s*$/;
            var campo1 = '';
            campo1 = $.trim(campo);
            if ((campo.match(letras)) && (campo1 != '')) {
                return true;
            } else {
                return false;
            }
        }

        function isEmpty(val) {
            return (val === undefined || val.trim() == null || val.trim().length <= 0) ? true : false;
        }


    </script>
    @RenderSection("EtiquetaHead", required: false)
</head>


<body id="blockui_sample_3_2_element" class="@claseMenu">
    
    @foreach (var item in toasts)  
                     {
        var itemStr = item.Split(',');
        <script>
            var toast = {
            titulo: '@itemStr[0]',
                mensaje: '@itemStr[1]'
            };
        toasts.push(toast);
        </script>
    }
    <div class="page-header navbar navbar-fixed-top">
        <div class="page-header-inner ">
            <div class="page-logo">
                <a href="@Url.Action("Index","Inicio")">
                    <img style="width:174px; height:auto;" src="@Url.Content("~/Content/img/logo.png")" alt="logo" class="logo-default" />
                </a>
                <div id="botonToggler" class="menu-toggler sidebar-toggler"></div>
            </div>
            <a href="javascript:;" class="menu-toggler responsive-toggler" data-toggle="collapse" data-target=".navbar-collapse"> </a>
            <div class="page-top">
                <div class="top-menu">
                    <ul class="nav navbar-nav pull-right">
                        <li class="separator hide"> </li>

                        <li class="dropdown dropdown-extended dropdown-inbox dropdown-dark" id="contenedorNotificaciones">
                           
                        </li>

                        <li class="separator hide"> </li>
                        <li class="dropdown dropdown-user">
                            <a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
                                @if (imageUsuario == null)
                                {
                                    <img src="@Url.Content("~/Content/Slices/profile.png")" class="img-circle" />
                                }
                                else
                                {
                                    <img src="data:image/png;base64,@imageUsuario" class="img-circle" />
                                }
                                <span class="username username-hide-on-mobile"> @oUsuario.NickName </span>
                                <i class="fa fa-angle-down"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-default">
                                <li>
                                    <a href="@Url.Action("Index", "CambioContrasena")">
                                        <i class="icon-key"></i> Cambiar Contraseña
                                    </a>
                                </li>
                                <li class="divider"> </li>
                                <li>
                                    <a href="@Url.Action("Bloquear", "Login")">
                                        <i class="icon-lock"></i> Bloquear sesión
                                    </a>
                                </li>
                                <li>
                                    <a href="@Url.Action("CerrarSesion", "Login")">
                                        <i class="icon-logout"></i> Cerrar sesión
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="clearfix"> </div>
    <div class="page-container">
        <div class="page-sidebar-wrapper">
            <div class="page-sidebar navbar-collapse collapse">
                @if (oUsuario != null)
                {
                    @Html.Partial("_Menu", NUsuarioAdministrativo.DevolverMenu(oUsuario))
                }
            </div>
        </div>
        <div class="page-content-wrapper">
            <div class="page-content">
               
                @RenderBody()
                <audio id="audio" src="~/Images/mensaje_ting.mp3" controls="controls" hidden />
            </div>
        </div>
      
    </div>
    <input type="hidden"  id="token" value=""/>
    @RenderSection("scripts", required: false)
    
    @*<script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-messaging.js"></script>*@
     
    <script>
    @*var firebaseConfig = {
        apiKey: "AIzaSyDuETtPsP297zh8N5VVLPrwc8nunSxWWek",
        authDomain: "yaigo-1522251423246.firebaseapp.com",
        databaseURL: "https://yaigo-1522251423246.firebaseio.com",
        projectId: "yaigo-1522251423246",
        storageBucket: "yaigo-1522251423246.appspot.com",
        messagingSenderId: "933243260335",
        appId: "1:933243260335:web:3b3bf0e302554561"
    };
    firebase.initializeApp(firebaseConfig);


    const messaging = firebase.messaging();
    messaging.usePublicVapidKey("BDHOTO5FJNjhmeHWOzppDjzV5V82vz7bJ2vsy1G4tMQAp3_nqJ_Xw313cnF7sr162UFn4bAMI0jfgCTpIR93P0E");

    Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            actualizarToken();
        } else {
            console.log('Unable to get permission to notify.');
        }
    });

    messaging.onMessage((payload) => {
        cargarNotificaciones();
        actualizarToken();

        var obj = JSON.parse(payload.data.notification);
        console.log('MESSAGE RECEIVED. ', obj);

        toastr.options.timeOut = 4000;
        toastr.options.extendedTimeOut = 4000;
        toastr.success(obj.body, obj.title, {
            onclick: function () {
                window.location = obj.click_action;
            }
        });
    });*@

    cargarNotificaciones();


    function cargarNotificaciones()
    {
        $.ajax({
            url: "@Url.Action("ObtenerNotificaciones", "Inicio")",
            cache: false,
            data: {
            },
            type: "POST"
        }).done(function (response) {
            $('#contenedorNotificaciones').html(response);
            console.log("repitiendo cargar notificaciones " + $("#list_notificacion").find("li").length);

            if ($("#list_notificacion").find("li").length>0) {
                var audio = document.getElementById("audio");
                audio.play();
            }


        }).error(function () {
        });
    }


    @*function actualizarToken()
    {
        messaging.getToken().then((currentToken) => {
            if (currentToken) {
                    console.log("token : " + currentToken);
                    $('#token').val(currentToken);
                    $.ajax({
                        url: "@Url.Action("RegistroFirebaseWeb", "Inicio")",
                        cache: false,
                        data: {
                            token: currentToken
                        },
                        type: "POST"
                    }).done(function (response) {

                    }).error(function () {
                    });
            } else {
                console.log('No Instance ID token available. Request permission to generate one.');
            }
        }).catch((err) => {
            console.log('An error occurred while retrieving token. ', err);

        });

    }*@

        function MarcarNotificacionLeida(url, idNotificacion) {
            $.ajax({
                url: "@Url.Action("MarcarNotificacionLeida", "Inicio")",
                cache: false,
                data: {
                    idNotificacion: idNotificacion
                },
                type: "POST"
            }).complete(function () {
                window.location = url;
            }).done(function () {

            }).error(function () {
            });
        }


        function EliminarNotificaciones() {
            $.ajax({
                url: "@Url.Action("EliminarNotificaciones", "Inicio")",
                cache: false,
                data: {
                },
                type: "POST",
                dataType: "script"
            }).complete(function () {
                actualizarToken();
                cargarNotificaciones();
            }).done(function () {
            }).error(function () {
            });
        }

        /*$(document).ready(function () {
            window.setInterval(function () {
                cargarNotificaciones();
            }, 550000);
        });*/
    </script>
</body>
</html>
